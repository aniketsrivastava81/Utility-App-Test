<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>IoT Blockchain DApp</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css"/>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 0;
            background-color: #f5f5f5;
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            overflow: hidden;
        }

        .container {
            width: 100%;
            max-width: 900px;
            background: white;
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 0 15px rgba(0, 0, 0, 0.1);
        }

        .tab {
            display: flex;
            justify-content: space-around;
            margin-bottom: 20px;
        }

        .tab button {
            background-color: #4CAF50;
            color: white;
            padding: 10px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            transition: transform 0.3s ease-in-out;
        }

        .tab button:hover {
            transform: scale(1.1);
        }

        .data-container {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 20px;
            margin-bottom: 20px;
        }

        .data-card {
            padding: 15px;
            border-radius: 8px;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .data-card h3 {
            margin: 0;
            font-size: 24px;
            color: #333;
        }

        .data-card p {
            font-size: 18px;
            margin: 5px 0;
        }

        .footer {
            margin-top: 20px;
            text-align: center;
        }

        .button {
            padding: 12px 25px;
            background-color: #4CAF50;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            transition: transform 0.3s ease-in-out;
        }

        .button:hover {
            transform: scale(1.1);
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }

        table, th, td {
            border: 1px solid #ddd;
        }

        th, td {
            padding: 10px;
            text-align: center;
        }

        th {
            background-color: #f2f2f2;
        }

    </style>
</head>
<body>

<div class="container">
    <div class="tab">
        <button id="temperature-tab">Temperature</button>
        <button id="humidity-tab">Humidity</button>
        <button id="water-level-tab">Water Level</button>
        <button id="alerts-tab">Alerts</button>
    </div>

    <div class="data-container">
        <div class="data-card" id="temperature-card">
            <h3>Temperature</h3>
            <p id="temperature">Loading...</p>
        </div>
        <div class="data-card" id="humidity-card">
            <h3>Humidity</h3>
            <p id="humidity">Loading...</p>
        </div>
        <div class="data-card" id="water-level-card">
            <h3>Water Level</h3>
            <p id="water-level">Loading...</p>
        </div>
        <div class="data-card" id="fire-alert-card">
            <h3>Fire Alert</h3>
            <p id="fire-alert">Loading...</p>
        </div>
        <div class="data-card" id="smoke-alert-card">
            <h3>Smoke Alert</h3>
            <p id="smoke-alert">Loading...</p>
        </div>
    </div>

    <div class="footer">
        <button class="button" id="retrieve-values">Retrieve Values</button>
        <button class="button" id="clear-screen">Clear Screen</button>
    </div>

    <table id="data-table">
        <thead>
            <tr>
                <th>Temperature</th>
                <th>Humidity</th>
                <th>Water Level</th>
                <th>Fire Alert</th>
                <th>Smoke Alert</th>
            </tr>
        </thead>
        <tbody>
            <!-- Data from MetaMask blockchain will be inserted here -->
        </tbody>
    </table>
</div>

<!-- Import ethers.js library -->
<script src="https://cdn.jsdelivr.net/npm/ethers@6.7.0/dist/ethers.umd.min.js"></script>

<script>
    document.addEventListener("DOMContentLoaded", async function () {
        const contractAddress = '0xc7078770ACFa5fC020b3469D672a530057B8a0b3'; // Replace with your actual contract address
        const contractABI = [
    {
        "anonymous": false,
        "inputs": [
            {
                "indexed": false,
                "internalType": "string",
                "name": "id",
                "type": "string"
            },
            {
                "indexed": false,
                "internalType": "string",
                "name": "temperature",
                "type": "string"
            },
            {
                "indexed": false,
                "internalType": "string",
                "name": "humidity",
                "type": "string"
            },
            {
                "indexed": false,
                "internalType": "string",
                "name": "waterLevel",
                "type": "string"
            },
            {
                "indexed": false,
                "internalType": "string",
                "name": "fireAlert",
                "type": "string"
            },
            {
                "indexed": false,
                "internalType": "string",
                "name": "smokeAlert",
                "type": "string"
            }
        ],
        "name": "SensorDataAdded",
        "type": "event"
    },
    {
        "anonymous": false,
        "inputs": [
            {
                "indexed": false,
                "internalType": "string",
                "name": "id",
                "type": "string"
            },
            {
                "indexed": false,
                "internalType": "string",
                "name": "temperature",
                "type": "string"
            },
            {
                "indexed": false,
                "internalType": "string",
                "name": "humidity",
                "type": "string"
            },
            {
                "indexed": false,
                "internalType": "string",
                "name": "waterLevel",
                "type": "string"
            },
            {
                "indexed": false,
                "internalType": "string",
                "name": "fireAlert",
                "type": "string"
            },
            {
                "indexed": false,
                "internalType": "string",
                "name": "smokeAlert",
                "type": "string"
            }
        ],
        "name": "SensorDataModified",
        "type": "event"
    },
    {
        "inputs": [
            {
                "internalType": "string",
                "name": "_id",
                "type": "string"
            },
            {
                "internalType": "string",
                "name": "_temperature",
                "type": "string"
            },
            {
                "internalType": "string",
                "name": "_humidity",
                "type": "string"
            },
            {
                "internalType": "string",
                "name": "_waterLevel",
                "type": "string"
            },
            {
                "internalType": "string",
                "name": "_fireAlert",
                "type": "string"
            },
            {
                "internalType": "string",
                "name": "_smokeAlert",
                "type": "string"
            }
        ],
        "name": "addSensorData",
        "outputs": [],
        "stateMutability": "nonpayable",
        "type": "function"
    },
    {
        "inputs": [],
        "name": "getSensorData",
        "outputs": [
            {
                "internalType": "string",
                "name": "",
                "type": "string"
            }
        ],
        "stateMutability": "view",
        "type": "function"
    },
    {
        "inputs": [
            {
                "internalType": "string",
                "name": "_id",
                "type": "string"
            },
            {
                "internalType": "string",
                "name": "_temperature",
                "type": "string"
            },
            {
                "internalType": "string",
                "name": "_humidity",
                "type": "string"
            },
            {
                "internalType": "string",
                "name": "_waterLevel",
                "type": "string"
            },
            {
                "internalType": "string",
                "name": "_fireAlert",
                "type": "string"
            },
            {
                "internalType": "string",
                "name": "_smokeAlert",
                "type": "string"
            }
        ],
        "name": "modifySensorData",
        "outputs": [
            {
                "internalType": "bool",
                "name": "success",
                "type": "bool"
            }
        ],
        "stateMutability": "nonpayable",
        "type": "function"
    },
    {
        "inputs": [
            {
                "internalType": "uint256",
                "name": "",
                "type": "uint256"
            }
        ],
        "name": "sensorData",
        "outputs": [
            {
                "internalType": "string",
                "name": "id",
                "type": "string"
            },
            {
                "internalType": "string",
                "name": "temperature",
                "type": "string"
            },
            {
                "internalType": "string",
                "name": "humidity",
                "type": "string"
            },
            {
                "internalType": "string",
                "name": "waterLevel",
                "type": "string"
            },
            {
                "internalType": "string",
                "name": "fireAlert",
                "type": "string"
            },
            {
                "internalType": "string",
                "name": "smokeAlert",
                "type": "string"
            }
        ],
        "stateMutability": "view",
        "type": "function"
    }
];

        // Fetch sensor data from the blockchain using MetaMask
        async function fetchSensorData() {
            if (typeof window.ethereum !== 'undefined' && window.ethereum.isMetaMask) {
                try {
                    const provider = new ethers.BrowserProvider(window.ethereum);
                    const signer = await provider.getSigner();
                    const contract = new ethers.Contract(contractAddress, contractABI, signer);
                    let i = 0;
                    let data = [];
                    while (true) {
                        try {
                            const sensor = await contract.sensorData(i);
                            data.push(sensor);
                            i++;
                        } catch (error) {
                            break;
                        }
                    }
                    displayDataInTable(data);
                    updateDataCards(data[0]); // Update the first row data to the cards
                } catch (error) {
                    console.error("Error fetching data from the blockchain:", error);
                }
            } else {
                alert('MetaMask is not installed. Please install MetaMask.');
            }
        }

        // Display the data in the table
        function displayDataInTable(data) {
            const tableBody = document.querySelector('#data-table tbody');
            tableBody.innerHTML = '';
            data.forEach((sensor) => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${sensor.temperature}</td>
                    <td>${sensor.humidity}</td>
                    <td>${sensor.waterLevel}</td>
                    <td>${sensor.fireAlert}</td>
                    <td>${sensor.smokeAlert}</td>
                `;
                tableBody.appendChild(row);
            });
        }

        // Update the relevant data cards
        function updateDataCards(data) {
            // Update text content of the cards
            document.getElementById('temperature').innerText = data.temperature;
            document.getElementById('humidity').innerText = data.humidity;
            document.getElementById('water-level').innerText = data.waterLevel;
            document.getElementById('fire-alert').innerText = data.fireAlert;
            document.getElementById('smoke-alert').innerText = data.smokeAlert;

            // Set background color for the cards
            const tempCard = document.getElementById('temperature-card');
            if (parseFloat(data.temperature) < 75 || parseFloat(data.temperature) > 105) {
                tempCard.style.backgroundColor = 'red';
            } else {
                tempCard.style.backgroundColor = 'green';
            }

            const humidityCard = document.getElementById('humidity-card');
            if (parseFloat(data.humidity) > 80) {
                humidityCard.style.backgroundColor = 'green';
            } else {
                humidityCard.style.backgroundColor = 'red';
            }

            const waterCard = document.getElementById('water-level-card');
            if (data.waterLevel === 'High') {
                waterCard.style.backgroundColor = 'green';
            } else if (data.waterLevel === 'OK') {
                waterCard.style.backgroundColor = 'yellow';
            } else {
                waterCard.style.backgroundColor = 'red';
            }

            const fireAlertCard = document.getElementById('fire-alert-card');
            const smokeAlertCard = document.getElementById('smoke-alert-card');
            if (data.fireAlert === 'YES') {
                fireAlertCard.style.backgroundColor = 'red';
            } else {
                fireAlertCard.style.backgroundColor = 'green';
            }

            if (data.smokeAlert === 'YES') {
                smokeAlertCard.style.backgroundColor = 'red';
            } else {
                smokeAlertCard.style.backgroundColor = 'green';
            }
        }

        // Button to retrieve data from the blockchain
        document.getElementById('retrieve-values').addEventListener('click', () => {
            fetchSensorData(); // Fetch and display blockchain data
        });

        // Button to clear the screen (reset values)
        document.getElementById('clear-screen').addEventListener('click', () => {
            clearFields(); // Reset all fields and colors
        });

        // Tab switching logic for temperature, humidity, water level, and alerts
        document.getElementById('temperature-tab').addEventListener('click', () => {
            document.getElementById('temperature-card').style.display = 'block';
            document.getElementById('humidity-card').style.display = 'none';
            document.getElementById('water-level-card').style.display = 'none';
            document.getElementById('fire-alert-card').style.display = 'none';
            document.getElementById('smoke-alert-card').style.display = 'none';
        });

        document.getElementById('humidity-tab').addEventListener('click', () => {
            document.getElementById('temperature-card').style.display = 'none';
            document.getElementById('humidity-card').style.display = 'block';
            document.getElementById('water-level-card').style.display = 'none';
            document.getElementById('fire-alert-card').style.display = 'none';
            document.getElementById('smoke-alert-card').style.display = 'none';
        });

        document.getElementById('water-level-tab').addEventListener('click', () => {
            document.getElementById('temperature-card').style.display = 'none';
            document.getElementById('humidity-card').style.display = 'none';
            document.getElementById('water-level-card').style.display = 'block';
            document.getElementById('fire-alert-card').style.display = 'none';
            document.getElementById('smoke-alert-card').style.display = 'none';
        });

        document.getElementById('alerts-tab').addEventListener('click', () => {
            document.getElementById('temperature-card').style.display = 'none';
            document.getElementById('humidity-card').style.display = 'none';
            document.getElementById('water-level-card').style.display = 'none';
            document.getElementById('fire-alert-card').style.display = 'block';
            document.getElementById('smoke-alert-card').style.display = 'block';
        });
    });

    // Clear all data fields
    function clearFields() {
        document.getElementById('temperature').innerText = 'Loading...';
        document.getElementById('humidity').innerText = 'Loading...';
        document.getElementById('water-level').innerText = 'Loading...';
        document.getElementById('fire-alert').innerText = 'Loading...';
        document.getElementById('smoke-alert').innerText = 'Loading...';

        // Showing all cards
        document.getElementById('temperature-card').style.display = 'block';
        document.getElementById('humidity-card').style.display = 'block';
        document.getElementById('water-level-card').style.display = 'block';
        document.getElementById('fire-alert-card').style.display = 'block';
        document.getElementById('smoke-alert-card').style.display = 'block';

        // Reset all tab backgrounds to white
        document.getElementById('temperature-card').style.backgroundColor = 'white';
        document.getElementById('humidity-card').style.backgroundColor = 'white';
        document.getElementById('water-level-card').style.backgroundColor = 'white';
        document.getElementById('fire-alert-card').style.backgroundColor = 'white';
        document.getElementById('smoke-alert-card').style.backgroundColor = 'white';
    }

</script>

</body>
</html>
