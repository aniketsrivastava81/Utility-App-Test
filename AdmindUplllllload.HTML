<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MetaMask Signed Sensor Data Upload</title>
    <script type="module">
        import { ethers } from "https://cdnjs.cloudflare.com/ajax/libs/ethers/6.7.0/ethers.min.js";

        document.addEventListener("DOMContentLoaded", function () {
            console.log("DOM fully loaded.");

            // Contract ABI and Address
            const contractAddress = '0xc7078770ACFa5fC020b3469D672a530057B8a0b3'; // Replace with your actual contract address
            const contractABI = [
	{
		"anonymous": false,
		"inputs": [
			{
				"indexed": false,
				"internalType": "string",
				"name": "id",
				"type": "string"
			},
			{
				"indexed": false,
				"internalType": "string",
				"name": "temperature",
				"type": "string"
			},
			{
				"indexed": false,
				"internalType": "string",
				"name": "humidity",
				"type": "string"
			},
			{
				"indexed": false,
				"internalType": "string",
				"name": "waterLevel",
				"type": "string"
			},
			{
				"indexed": false,
				"internalType": "string",
				"name": "fireAlert",
				"type": "string"
			},
			{
				"indexed": false,
				"internalType": "string",
				"name": "smokeAlert",
				"type": "string"
			}
		],
		"name": "SensorDataAdded",
		"type": "event"
	},
	{
		"anonymous": false,
		"inputs": [
			{
				"indexed": false,
				"internalType": "string",
				"name": "id",
				"type": "string"
			},
			{
				"indexed": false,
				"internalType": "string",
				"name": "temperature",
				"type": "string"
			},
			{
				"indexed": false,
				"internalType": "string",
				"name": "humidity",
				"type": "string"
			},
			{
				"indexed": false,
				"internalType": "string",
				"name": "waterLevel",
				"type": "string"
			},
			{
				"indexed": false,
				"internalType": "string",
				"name": "fireAlert",
				"type": "string"
			},
			{
				"indexed": false,
				"internalType": "string",
				"name": "smokeAlert",
				"type": "string"
			}
		],
		"name": "SensorDataModified",
		"type": "event"
	},
	{
		"inputs": [
			{
				"internalType": "string",
				"name": "_id",
				"type": "string"
			},
			{
				"internalType": "string",
				"name": "_temperature",
				"type": "string"
			},
			{
				"internalType": "string",
				"name": "_humidity",
				"type": "string"
			},
			{
				"internalType": "string",
				"name": "_waterLevel",
				"type": "string"
			},
			{
				"internalType": "string",
				"name": "_fireAlert",
				"type": "string"
			},
			{
				"internalType": "string",
				"name": "_smokeAlert",
				"type": "string"
			}
		],
		"name": "addSensorData",
		"outputs": [],
		"stateMutability": "nonpayable",
		"type": "function"
	},
	{
		"inputs": [],
		"name": "getSensorData",
		"outputs": [
			{
				"internalType": "string",
				"name": "",
				"type": "string"
			}
		],
		"stateMutability": "view",
		"type": "function"
	},
	{
		"inputs": [
			{
				"internalType": "string",
				"name": "_id",
				"type": "string"
			},
			{
				"internalType": "string",
				"name": "_temperature",
				"type": "string"
			},
			{
				"internalType": "string",
				"name": "_humidity",
				"type": "string"
			},
			{
				"internalType": "string",
				"name": "_waterLevel",
				"type": "string"
			},
			{
				"internalType": "string",
				"name": "_fireAlert",
				"type": "string"
			},
			{
				"internalType": "string",
				"name": "_smokeAlert",
				"type": "string"
			}
		],
		"name": "modifySensorData",
		"outputs": [
			{
				"internalType": "bool",
				"name": "success",
				"type": "bool"
			}
		],
		"stateMutability": "nonpayable",
		"type": "function"
	},
	{
		"inputs": [
			{
				"internalType": "uint256",
				"name": "",
				"type": "uint256"
			}
		],
		"name": "sensorData",
		"outputs": [
			{
				"internalType": "string",
				"name": "id",
				"type": "string"
			},
			{
				"internalType": "string",
				"name": "temperature",
				"type": "string"
			},
			{
				"internalType": "string",
				"name": "humidity",
				"type": "string"
			},
			{
				"internalType": "string",
				"name": "waterLevel",
				"type": "string"
			},
			{
				"internalType": "string",
				"name": "fireAlert",
				"type": "string"
			},
			{
				"internalType": "string",
				"name": "smokeAlert",
				"type": "string"
			}
		],
		"stateMutability": "view",
		"type": "function"
	}
];
            console.log("Contract ABI and Address set.");

            // Function to connect to MetaMask and upload sensor data
            async function connectAndUploadData(event) {
                console.log("connectAndUploadData triggered.");
                event.preventDefault();

                if (typeof window.ethereum !== 'undefined' && window.ethereum.isMetaMask) {
                    try {
                        const accounts = await window.ethereum.request({ method: 'eth_requestAccounts' });
                        console.log("MetaMask accounts:", accounts);

                        if (!accounts.length) {
                            console.error("No accounts found in MetaMask.");
                            alert("Please select an account in MetaMask.");
                            return;
                        }

                        const provider = new ethers.BrowserProvider(window.ethereum);
                        const signer = await provider.getSigner();
                        console.log("Signer obtained.");

                        const contract = new ethers.Contract(contractAddress, contractABI, signer);
                        console.log("Contract instance created.");

                        const id = document.getElementById('id').value;
                        const temperature = document.getElementById('temperature').value;
                        const humidity = document.getElementById('humidity').value;
                        const waterLevel = document.getElementById('waterLevel').value;
                        const fireAlert = document.getElementById('fireAlert').value;
                        const smokeAlert = document.getElementById('smokeAlert').value;
                        console.log("Collected form data:", id, temperature, humidity, waterLevel, fireAlert, smokeAlert);

                        const transaction = await contract.addSensorData(
                            id, temperature, humidity, waterLevel, fireAlert, smokeAlert
                        );
                        console.log("Transaction sent:", transaction);

                        await transaction.wait();
                        console.log("Transaction mined.");

                        alert('Data successfully uploaded to the blockchain!');
                    } catch (error) {
                        console.error("Error uploading data to the blockchain:", error);
                        alert('Error uploading data');
                    }
                } else {
                    alert('MetaMask is not installed. Please install MetaMask.');
                    console.log("MetaMask is not installed.");
                }
            }

            // Function to modify sensor data based on ID
            async function modifySensorData(event) {
                console.log("modifySensorData triggered.");
                event.preventDefault();

                if (typeof window.ethereum !== 'undefined' && window.ethereum.isMetaMask) {
                    try {
                        const accounts = await window.ethereum.request({ method: 'eth_requestAccounts' });
                        console.log("MetaMask accounts:", accounts);

                        if (!accounts.length) {
                            console.error("No accounts found in MetaMask.");
                            alert("Please select an account in MetaMask.");
                            return;
                        }

                        const provider = new ethers.BrowserProvider(window.ethereum);
                        const signer = await provider.getSigner();
                        console.log("Signer obtained.");

                        const contract = new ethers.Contract(contractAddress, contractABI, signer);
                        console.log("Contract instance created.");

                        const id = document.getElementById('modifyId').value;
                        const temperature = document.getElementById('modifyTemperature').value;
                        const humidity = document.getElementById('modifyHumidity').value;
                        const waterLevel = document.getElementById('modifyWaterLevel').value;
                        const fireAlert = document.getElementById('modifyFireAlert').value;
                        const smokeAlert = document.getElementById('modifySmokeAlert').value;
                        console.log("Collected modify data:", id, temperature, humidity, waterLevel, fireAlert, smokeAlert);

                        const transaction = await contract.modifySensorData(
                            id, temperature, humidity, waterLevel, fireAlert, smokeAlert
                        );
                        console.log("Transaction sent:", transaction);

                        await transaction.wait();
                        console.log("Transaction mined.");

                        alert('Sensor data successfully modified on the blockchain!');
                    } catch (error) {
                        console.error("Error modifying sensor data on the blockchain:", error);
                        alert('Error modifying data');
                    }
                } else {
                    alert('MetaMask is not installed. Please install MetaMask.');
                    console.log("MetaMask is not installed.");
                }
            }

            // Event listener for the "Upload Data" button
            document.getElementById('uploadDataBtn').addEventListener('click', connectAndUploadData);

            // Event listener for the "Modify Sensor Data" button
            document.getElementById('modifyDataBtn').addEventListener('click', modifySensorData);
        });
    </script>
</head>
<body>
    <h1>MetaMask Signed Sensor Data Upload</h1>

    <!-- Input form for uploading data -->
    <form id="sensorForm">
        <label for="id">Sensor ID:</label>
        <input type="text" id="id" placeholder="Sensor ID" required>

        <label for="temperature">Temperature:</label>
        <input type="text" id="temperature" placeholder="Temperature" required>

        <label for="humidity">Humidity:</label>
        <input type="text" id="humidity" placeholder="Humidity" required>

        <label for="waterLevel">Water Level:</label>
        <input type="text" id="waterLevel" placeholder="Water Level" required>

        <label for="fireAlert">Fire Alert:</label>
        <input type="text" id="fireAlert" placeholder="Fire Alert" required>

        <label for="smokeAlert">Smoke Alert:</label>
        <input type="text" id="smokeAlert" placeholder="Smoke Alert" required>

        <button type="submit" id="uploadDataBtn">Upload Data to Blockchain</button>
    </form>

    <!-- Input form for modifying data -->
    <h2>Modify Sensor Data</h2>
    <form id="modifySensorForm">
        <label for="modifyId">Sensor ID:</label>
        <input type="text" id="modifyId" placeholder="Sensor ID to modify" required>

        <label for="modifyTemperature">Temperature:</label>
        <input type="text" id="modifyTemperature" placeholder="New Temperature" required>

        <label for="modifyHumidity">Humidity:</label>
        <input type="text" id="modifyHumidity" placeholder="New Humidity" required>

        <label for="modifyWaterLevel">Water Level:</label>
        <input type="text" id="modifyWaterLevel" placeholder="New Water Level" required>

        <label for="modifyFireAlert">Fire Alert:</label>
        <input type="text" id="modifyFireAlert" placeholder="New Fire Alert" required>

        <label for="modifySmokeAlert">Smoke Alert:</label>
        <input type="text" id="modifySmokeAlert" placeholder="New Smoke Alert" required>

        <button type="submit" id="modifyDataBtn">Modify Sensor Data</button>
    </form>
</body>
</html>
